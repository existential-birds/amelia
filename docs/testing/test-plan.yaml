version: 1
metadata:
  branch: feat/auto-build-dashboard
  base: main
  generated: "2026-01-26"
  changes_summary: |
    Auto-build dashboard on `amelia dev` startup. When the dev server starts and
    the dashboard has not been built yet (no static/index.html), it now runs
    `pnpm build` automatically before launching the Vite dev server. Also fixes
    the dev-mode dashboard URL in the banner from port 5173 to 8421.

    Changed files:
    - amelia/server/banner.py: Update dev-mode dashboard URL from 5173 â†’ 8421
    - amelia/server/dev.py: Add check_dashboard_built(), run_pnpm_build(), and
      auto-build step in run_dev_mode()
    - tests/unit/server/test_banner.py: Tests for updated banner URL
    - tests/unit/server/test_dev.py: Tests for build check and pnpm build

setup:
  stack:
    - type: python
      package_manager: uv
    - type: node
      package_manager: pnpm
  commands:
    - uv sync
    - cd dashboard && pnpm install
  health_checks:
    - url: http://localhost:8420/api/live
      timeout: 30
    - url: http://localhost:8421
      timeout: 30

tests:
  # --- Unit test verification ---
  - id: TC-01
    name: Run unit tests for changed files
    context: |
      The branch includes new unit tests in test_banner.py and test_dev.py.
      Verify they pass before proceeding to manual tests.
    steps:
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          uv run pytest tests/unit/server/test_banner.py tests/unit/server/test_dev.py -v
    expected: |
      All tests pass, including:
      - TestGetServiceUrlsDisplay::test_dev_mode_shows_vite_port (port 8421)
      - TestGetServiceUrlsDisplay::test_user_mode_shows_api_port (port 8420)
      - TestDependencyChecks::test_check_dashboard_built[built] (True)
      - TestDependencyChecks::test_check_dashboard_built[not_built] (False)
      - TestAutoBuild::test_run_pnpm_build[success] (True)
      - TestAutoBuild::test_run_pnpm_build[failure] (False)

  # --- Auto-build behavior: dashboard not yet built ---
  - id: TC-02
    name: "Auto-build triggers when dashboard is not built"
    context: |
      amelia/server/dev.py now calls check_dashboard_built() in run_dev_mode().
      If static/index.html is missing, it should run pnpm build before starting
      the Vite dev server. This is the primary feature being added.
    steps:
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          rm -f amelia/server/static/index.html
        note: "Remove built dashboard to simulate first-time setup"
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          timeout 90 uv run amelia dev 2>&1 | head -60
        note: "Start dev server and capture first 60 lines of output"
    expected: |
      Output should show:
      1. "Building dashboard..." message with dashboard prefix
      2. pnpm/vite build output lines
      3. After build completes, "Starting vite on http://localhost:8421"
      4. The file amelia/server/static/index.html should now exist
    evidence:
      screenshot: evidence/tc-02.png

  # --- Auto-build skipped when already built ---
  - id: TC-03
    name: "Auto-build skips when dashboard is already built"
    context: |
      If static/index.html already exists, the auto-build step should be skipped
      entirely. This avoids unnecessary rebuilds on normal restarts.
    steps:
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          ls -la amelia/server/static/index.html
        note: "Confirm dashboard is already built (from TC-02 or prior build)"
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          timeout 30 uv run amelia dev 2>&1 | head -30
        note: "Start dev server and check output"
    expected: |
      Output should NOT contain "Building dashboard..." message.
      The server should start directly with:
      1. Banner display
      2. "Starting vite on http://localhost:8421"
      3. Uvicorn startup on port 8420

  # --- Banner URL correctness ---
  - id: TC-04
    name: "Banner shows correct dashboard URL in dev mode"
    context: |
      amelia/server/banner.py was changed to display port 8421 instead of 5173
      for the dashboard URL in dev mode. This should be visible in the startup banner.
    steps:
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          timeout 15 uv run amelia dev 2>&1 | head -40
        note: "Capture startup banner output"
    expected: |
      The startup banner should display:
      - Dashboard URL: http://localhost:8421
      - API URL: http://localhost:8420
      - Port 5173 should NOT appear anywhere in the output

  # --- Dashboard accessible on correct port ---
  - id: TC-05
    name: "Dashboard is accessible on port 8421 in dev mode"
    context: |
      With the port change from 5173 to 8421, the Vite dev server should
      actually be running on port 8421 and serving the dashboard.
    steps:
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          uv run amelia dev &
          sleep 15
        note: "Start dev server in background, wait for startup"
      - action: curl
        method: GET
        url: http://localhost:8421
      - action: curl
        method: GET
        url: http://localhost:8420/api/live
    expected: |
      - http://localhost:8421 returns HTML content (the dashboard SPA)
      - http://localhost:8420/api/live returns 200 OK health response
      - Both services are accessible simultaneously
    evidence:
      screenshot: evidence/tc-05.png

  # --- API serves built dashboard ---
  - id: TC-06
    name: "API server serves built dashboard on port 8420"
    context: |
      In non-dev mode (or when accessing the API port directly), the built
      dashboard should be served from the API server at port 8420 via the
      SPA fallback route. This verifies static file serving works with the
      auto-built output.
    steps:
      - action: agent-browser open
        url: http://localhost:8420
      - action: agent-browser snapshot
    expected: |
      The dashboard UI should load at http://localhost:8420, showing the
      workflows page (default redirect from /). The page should contain
      navigation elements for Workflows, History, Logs, Prompts, Settings, etc.
    evidence:
      screenshot: evidence/tc-06.png

  # --- Build failure handling ---
  - id: TC-07
    name: "Dev server exits gracefully on build failure"
    context: |
      If pnpm build fails, run_dev_mode() should print an error and return
      exit code 1 instead of continuing to start the dashboard. This is tested
      at unit level but worth verifying end-to-end.
    steps:
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          rm -f amelia/server/static/index.html &&
          mv dashboard/package.json dashboard/package.json.bak
        note: "Remove index.html and break the build by hiding package.json"
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          timeout 30 uv run amelia dev 2>&1; echo "EXIT_CODE=$?"
        note: "Attempt to start dev server with broken build"
      - action: shell
        command: >
          cd /Users/ka/github/existential-birds/amelia-feature &&
          mv dashboard/package.json.bak dashboard/package.json
        note: "Restore package.json"
    expected: |
      Output should show:
      1. "Building dashboard..." message
      2. Build failure output
      3. "Failed to build dashboard" error message
      4. EXIT_CODE=1 (non-zero exit)
      The Vite dev server should NOT have been started.
