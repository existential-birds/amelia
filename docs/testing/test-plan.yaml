version: 1
metadata:
  branch: feat/409-sandbox-foundation
  base: main
  generated: "2026-02-09T00:00:00Z"
  changes_summary: |
    Introduces sandbox infrastructure foundation:
    - New sandbox module with LLM proxy router and provider protocol
    - Database migration adding sandbox JSONB column to profiles
    - Proxy API routes for forwarding LLM requests (/proxy/v1/*)
    - Driver session management improvements (async cleanup, LRU eviction)
    - Core type enhancement: Profile now includes SandboxConfig
    - Agent/pipeline refactoring (schema extraction, evaluator updates)

setup:
  stack:
    - type: python
      package_manager: uv
    - type: node
      package_manager: pnpm
  commands:
    - uv sync
    - cd dashboard && pnpm install
  services:
    - name: postgresql
      required: true
      note: "Database must be running with amelia database created"
    - name: amelia-server
      command: "uv run amelia dev"
      note: "Starts backend on 8420 and serves dashboard"
  environment:
    - AMELIA_DATABASE_URL=postgresql://localhost:5432/amelia
    - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
  health_checks:
    - url: http://localhost:8420/api/health/live
      timeout: 30
    - url: http://localhost:8420/api/health/ready
      timeout: 30

tests:
  # ============================================================
  # TC-01: Database Migration - Sandbox Column
  # ============================================================
  - id: TC-01
    name: Verify sandbox column added to profiles table
    context: |
      amelia/server/database/migrations/002_add_sandbox_to_profiles.sql adds a
      JSONB 'sandbox' column to the profiles table. This migration must run on
      server startup without errors. Existing profiles should get a default
      empty sandbox config.
    steps:
      - action: curl
        method: GET
        url: http://localhost:8420/api/health/ready
      - action: curl
        method: GET
        url: http://localhost:8420/api/profiles
    expected: |
      - Health check returns 200 (migration ran successfully)
      - GET /api/profiles returns existing profiles without errors
      - No 500 errors related to missing sandbox column

  # ============================================================
  # TC-02: Profile CRUD with Sandbox Config
  # ============================================================
  - id: TC-02
    name: Create and retrieve profile with sandbox config preserved
    context: |
      amelia/core/types.py adds SandboxConfig to Profile model.
      amelia/server/database/profile_repository.py persists sandbox as JSONB.
      Profile creation should store sandbox config and retrieval should
      deserialize it correctly.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/api/profiles
        headers:
          Content-Type: application/json
        body: |
          {
            "name": "test-sandbox-profile",
            "driver": "api:openai",
            "model": "gpt-4o",
            "tracker": "none",
            "working_dir": "/tmp/amelia-test"
          }
      - action: curl
        method: GET
        url: http://localhost:8420/api/profiles
        note: "Find the created profile ID from the list"
    expected: |
      - Profile created successfully (201 or 200)
      - Profile can be retrieved without errors
      - Sandbox config defaults are applied (mode: "none")
      - No deserialization errors in server logs

  # ============================================================
  # TC-03: Proxy Router - Chat Completions Forwarding
  # ============================================================
  - id: TC-03
    name: Proxy forwards chat completion requests to upstream LLM
    context: |
      amelia/sandbox/proxy.py defines proxy routes mounted at /proxy/v1.
      amelia/server/main.py mounts the proxy router.
      The proxy resolves profile → provider config → forwards request.
      Requires OPENROUTER_API_KEY or OPENAI_API_KEY in environment.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/proxy/v1/chat/completions
        headers:
          Content-Type: application/json
          X-Amelia-Profile: default
        body: |
          {
            "model": "openai/gpt-4o-mini",
            "messages": [{"role": "user", "content": "Say hello in exactly one word."}],
            "max_tokens": 10
          }
    expected: |
      - Returns 200 with streaming or non-streaming chat completion response
      - Response contains choices with assistant message content
      - X-Amelia-Profile header is used to resolve provider config
      - If no API key configured, returns appropriate error (not 500)

  # ============================================================
  # TC-04: Proxy Router - Missing Profile Header
  # ============================================================
  - id: TC-04
    name: Proxy returns error when X-Amelia-Profile header is missing
    context: |
      amelia/sandbox/proxy.py requires X-Amelia-Profile header to resolve
      which provider/key to use. Missing header should return a clear error.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/proxy/v1/chat/completions
        headers:
          Content-Type: application/json
        body: |
          {
            "model": "gpt-4o-mini",
            "messages": [{"role": "user", "content": "hello"}]
          }
    expected: |
      - Returns 4xx error (400 or 422)
      - Error message indicates missing X-Amelia-Profile header
      - Does not return 500 (internal server error)

  # ============================================================
  # TC-05: Proxy Router - Invalid Profile Name
  # ============================================================
  - id: TC-05
    name: Proxy returns error for non-existent profile
    context: |
      amelia/sandbox/proxy.py resolves profile by name from database.
      A non-existent profile should return a clear error, not crash.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/proxy/v1/chat/completions
        headers:
          Content-Type: application/json
          X-Amelia-Profile: nonexistent-profile-xyz
        body: |
          {
            "model": "gpt-4o-mini",
            "messages": [{"role": "user", "content": "hello"}]
          }
    expected: |
      - Returns 404 or appropriate 4xx error
      - Error message indicates profile not found
      - Does not return 500 (internal server error)

  # ============================================================
  # TC-06: Proxy Router - Git Credentials Stub
  # ============================================================
  - id: TC-06
    name: Git credentials endpoint returns 501 Not Implemented
    context: |
      amelia/sandbox/proxy.py includes a git credentials stub at
      /proxy/v1/git/credentials that should return 501 in foundation phase.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/proxy/v1/git/credentials
        headers:
          Content-Type: application/json
          X-Amelia-Profile: default
    expected: |
      - Returns 501 (Not Implemented)
      - Response indicates this feature is not yet available

  # ============================================================
  # TC-07: Proxy Router - Embeddings Endpoint
  # ============================================================
  - id: TC-07
    name: Proxy forwards embedding requests
    context: |
      amelia/sandbox/proxy.py defines POST /proxy/v1/embeddings to forward
      embedding requests through the proxy.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/proxy/v1/embeddings
        headers:
          Content-Type: application/json
          X-Amelia-Profile: default
        body: |
          {
            "model": "text-embedding-3-small",
            "input": "test embedding input"
          }
    expected: |
      - Returns 200 with embedding response if API key is configured
      - Returns appropriate error if no valid embedding model/key configured
      - Does not return 500

  # ============================================================
  # TC-08: Existing Workflows Not Broken
  # ============================================================
  - id: TC-08
    name: Verify existing workflow creation still works
    context: |
      Multiple files changed in agents, drivers, and pipelines.
      amelia/agents/architect.py, amelia/agents/evaluator.py,
      amelia/drivers/base.py (async cleanup_session), and
      amelia/pipelines/implementation/* were modified.
      Must verify the core orchestration flow is not broken.
    steps:
      - action: curl
        method: GET
        url: http://localhost:8420/api/workflows/active
      - action: curl
        method: GET
        url: http://localhost:8420/api/profiles
        note: "Verify there is an active profile to use"
    expected: |
      - GET /api/workflows/active returns 200 with array (may be empty)
      - GET /api/profiles returns 200 with at least one profile
      - No errors in server logs related to async cleanup_session

  # ============================================================
  # TC-09: Brainstorm Service with Async Cleanup
  # ============================================================
  - id: TC-09
    name: Brainstorm session creation and messaging works with async driver cleanup
    context: |
      amelia/server/services/brainstorm.py uses driver cleanup_session which
      changed from sync to async. amelia/drivers/base.py changed the signature.
      Must verify brainstorm sessions still work end-to-end.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/api/brainstorm/sessions
        headers:
          Content-Type: application/json
        body: |
          {
            "topic": "Test sandbox integration"
          }
      - action: curl
        method: GET
        url: http://localhost:8420/api/brainstorm/sessions
    expected: |
      - Session created successfully (200/201)
      - Session appears in list of sessions
      - No errors related to async/sync mismatch in cleanup

  # ============================================================
  # TC-10: Dashboard - Settings Profiles Page
  # ============================================================
  - id: TC-10
    name: Dashboard profiles page loads without errors
    context: |
      Profile model now includes sandbox field. The dashboard fetches
      profiles via GET /api/profiles. Even though sandbox is not yet
      exposed in ProfileResponse, the dashboard must not break when
      the backend returns profiles with sandbox data.
    steps:
      - action: agent-browser open
        url: http://localhost:8420/settings/profiles
      - action: agent-browser snapshot
        note: "Verify profiles page renders"
      - action: agent-browser snapshot
        note: "Check for any error banners or broken UI"
    expected: |
      - Settings profiles page loads successfully
      - Existing profiles are listed
      - No JavaScript errors in console
      - No broken UI elements or error banners
    evidence:
      screenshot: evidence/tc-10-profiles-page.png

  # ============================================================
  # TC-11: Dashboard - Workflows Page
  # ============================================================
  - id: TC-11
    name: Dashboard workflows page loads and displays correctly
    context: |
      Core pipeline and agent changes could affect workflow data
      structures. The dashboard workflows page must still render
      correctly with the updated event models.
    steps:
      - action: agent-browser open
        url: http://localhost:8420/workflows
      - action: agent-browser snapshot
        note: "Verify workflows page renders"
    expected: |
      - Workflows page loads without errors
      - Canvas visualization renders (even if empty)
      - No JavaScript errors in console
    evidence:
      screenshot: evidence/tc-11-workflows-page.png

  # ============================================================
  # TC-12: Dashboard - Brainstorm/Specs Page
  # ============================================================
  - id: TC-12
    name: Dashboard specs page loads and can create sessions
    context: |
      Brainstorm service changed (async cleanup). Events model updated
      with EPHEMERAL_SEQUENCE. Must verify the specs/brainstorm page
      still works end-to-end.
    steps:
      - action: agent-browser open
        url: http://localhost:8420/specs
      - action: agent-browser snapshot
        note: "Verify specs page renders"
    expected: |
      - Specs page loads without errors
      - Session creation UI is functional
      - No WebSocket connection errors
    evidence:
      screenshot: evidence/tc-12-specs-page.png

  # ============================================================
  # TC-13: Server Health After Extended Operation
  # ============================================================
  - id: TC-13
    name: Server health endpoints respond after proxy and brainstorm usage
    context: |
      After exercising the proxy routes and brainstorm service,
      verify the server is still healthy. Driver session cleanup
      and LRU eviction should not cause resource leaks.
    steps:
      - action: curl
        method: GET
        url: http://localhost:8420/api/health
      - action: curl
        method: GET
        url: http://localhost:8420/api/health/live
      - action: curl
        method: GET
        url: http://localhost:8420/api/health/ready
    expected: |
      - All three health endpoints return 200
      - Ready check confirms database connectivity
      - No memory or connection pool exhaustion
